let cardNumArr=[];const col=8;let dataCollection,timerInt,gameState="";function buildCardNumArr(){for(var e=[],t=1;t<=52;t++)e.push(t);cardNumArr=shuffleArr(e)}function shuffleArr(e){for(var t,a,r=e.length;r;t=parseInt(Math.random()*r),a=e[--r],e[r]=e[t],e[t]=a);return e}function getDataCollection(){for(var e=[[],[],[],[],[],[],[],[]],t=0;t<cardNumArr.length;t++){var a=getSuit(cardNumArr[t])+(cardNumArr[t]%13+1).toString();e[t%col].push(a)}return e}function getSuit(e){return e<14?"S":e>13&&e<27?"H":e>26&&e<40?"D":"C"}function dealCard(){gameState="playing";for(let l=0;l<dataCollection.length;l++){var e=$(".working-area>li").eq(l);for(let i=0;i<dataCollection[l].length;i++){var t=dataCollection[l][i].toString(),a=t.slice(0,1),r=t.substring(1),n="<div id='"+t+"' class='card'  data-suit='"+a+"' data-num='"+r+"' data-color='"+("S"==a||"C"==a?"B":"R")+"' data-pos=[c"+l+"r"+i+"] style='background-image:"+('url("img/cards_background/'+t+'.png")')+"' draggable='"+(i==dataCollection[l].length-1)+"' ondragstart='drag(event)' ></div>";if(0==i)e.append(n);else{var o=dataCollection[l][i-1];$("#"+o).append(n)}}}}function dealTransition(){$(".card").on("click",cardClicked),$(".card").addClass("show"),updateDraggable(),startTimer()}function allowDrop(e){e.preventDefault(),e.target.classList.add("drop-target-focus")}function dragEnter(e){}function dragLeave(e){e.target.classList.remove("drop-target-focus")}function drag(e){e.dataTransfer.setData("text",e.target.id)}function dropHome(e){e.preventDefault();var t=e.dataTransfer.getData("text"),a=document.getElementById(t),r=e.target;r.classList.remove("drop-target-focus");var n=parseInt(a.getAttribute("data-num")),o=a.getAttribute("data-suit");if(!(a.childElementCount>0)){if(-1!=r.className.indexOf("home-cell")){if(-1==r.className.indexOf(o))return;if(n!=parseInt(r.getAttribute("data-top"))+1)return}else{if(r.getAttribute("data-suit")!=o)return;if(parseInt(r.getAttribute("data-num"))!=n-1)return}$("."+o+"-home").attr("data-top",n),a.setAttribute("draggable",!1),r.appendChild(a),updateDraggable()}}function dropTemp(e){e.preventDefault(),e.target.classList.remove("drop-target-focus");var t=e.dataTransfer.getData("text"),a=document.getElementById(t);a.childElementCount>0||-1!=e.target.className.indexOf("temp-cell")&&(a.setAttribute("data-pos",[]),e.target.appendChild(a),updateDraggable())}function drop(e){e.preventDefault();var t=e.dataTransfer.getData("text"),a=document.getElementById(t),r=e.target;r.classList.remove("drop-target-focus");var n,o=parseInt(a.getAttribute("data-num"));if(-1!=r.className.indexOf("cell")){if(r.childElementCount>0)return;n=$(r).index()}else{if(r.getAttribute("data-color")==a.getAttribute("data-color"))return;if(parseInt(r.getAttribute("data-num"))!=o+1)return;n=r.getAttribute("data-pos").substr(2,1)}r.appendChild(a),updateDraggable(),updateOrder(n)}function checkAutoHome(e,t){var a=e.getAttribute("data-suit"),r=e.getAttribute("data-num"),n=$(e);if(!(r>t))for(var o=0;o<$(".home-cell").length;o++){var l=$(".home-cell")[o];-1!=l.className.indexOf(a)&&l.getAttribute("data-top")==r-1&&(l.setAttribute("data-top",r),n.addClass("autohome"),t>2?setTimeout(goHome,300,l,e,r-1):setTimeout(goHome,1e3,l,e,r-1))}}function goHome(e,t,a){if(e.childElementCount>0){var r=e.querySelectorAll("div")[parseInt(a-1)];$(r).append(t)}else e.append(t);t.setAttribute("draggable",!1),t.classList.remove("autohome"),updateDraggable()}function updateOrder(e){for(var t=document.querySelectorAll(".working-area>li")[e],a=t.querySelectorAll("div").length,r=t,n=0;n<a;n++)newPos="[c"+e+"r"+n+"]",r.children[0].setAttribute("data-pos",newPos),r=r.children[0]}function updateDraggable(){for(let o=0;o<col;o++){var e=document.querySelectorAll(".working-area>li")[o].querySelectorAll("div"),t=e.length;if(0!=t){e[t-1].setAttribute("draggable",!0),checkAutoHome(e[t-1],2);for(var a=t-1;a>=0;a--){var r=e[a];if(0!=a){var n=e[a-1];if(parseInt(r.getAttribute("data-num"))!=parseInt(n.getAttribute("data-num"))-1)break;if(r.getAttribute("data-color")==n.getAttribute("data-color"))break;n.setAttribute("draggable",!0)}else 1==t&&r.setAttribute("draggable",!0)}}}checkWin()}function checkWin(){0==document.querySelectorAll('.working-area div[draggable="false"]').length&&autoEnd()}function autoEnd(){if(document.querySelectorAll(".working-area div").length>0||document.querySelectorAll(".temp-cell div").length>0){for(var e=0;e<col;e++){var t=document.querySelectorAll(".working-area>li")[e].querySelectorAll("div"),a=t.length;if(0!=a)checkAutoHome(t[a-1],13)}for(var r=0;r<document.querySelectorAll(".temp-cell").length;r++){var n=document.querySelectorAll(".temp-cell")[r];if(n.children.length>0)checkAutoHome(n.children[0],13)}}else gameState="win",showWinScreen()}function startTimer(){let e,t,a=0;timerInt=window.setInterval(()=>{"playing"==gameState&&(a++,e=parseInt(a/60,10),t=parseInt(a%60,10),e=e<10?`0${e}`:e,t=t<10?`0${t}`:t,$(".time>span").text(`${e}:${t}`))},1e3)}function cleanTimer(){null!=timerInt&&(window.clearInterval(timerInt),timerInt=void 0,$(".time>span").text("00:00"))}function cleanup(){$(".temp-cell").empty(),$(".home-cell").empty(),$(".home-cell").attr("data-top",0),$(".working-area>li").empty(),cleanTimer(),gameState=""}function newGame(){document.querySelector(".mask").classList.contains("show")&&closeMask(),"playing"!=gameState?(buildCardNumArr(),dataCollection=getDataCollection(),cleanup(),dealCard(),setTimeout(dealTransition,1e3)):showConfirmWindow()}function restartGame(){document.querySelector(".mask").classList.contains("show")&&closeMask(),cleanup(),dealCard(),setTimeout(dealTransition,1e3)}function confirmNewGame(){gameState="",newGame()}function cardClicked(e){e.stopPropagation(),console.log("cardClicked");var t=e.target,a=t.getAttribute("data-pos");if(""!=a){var r=a.substr(2,1),n=a.slice(4).slice(0,-1);document.querySelectorAll(".working-area>li")[r].querySelectorAll("div").length==parseInt(n)+1&&checkAutoHome(t,13)}else checkAutoHome(t,13)}function hintClicked(e){}function showConfirmWindow(){$(".mask").removeClass("hide").addClass("show"),$(".info-window .confirm-pan").addClass("show"),$(".info-window").removeClass("hide").addClass("show")}function showWinScreen(){$(".mask").removeClass("hide").addClass("show"),$(".info-window .win-pan").addClass("show"),$(".info-window").removeClass("hide").addClass("show")}function closeMask(){$(".info-window").removeClass("show"),$(".mask").removeClass("show"),setTimeout(hideMask,1e3)}function hideMask(){$(".info-window").addClass("hide"),$(".info-window .pan").removeClass("show"),$(".mask").addClass("hide")}$("document").ready(function(){$(".new-game-btn").on("click",newGame),$(".restart-btn").on("click",restartGame),$(".close-btn").on("click",closeMask),$(".new-game-confirm-btn").on("click",confirmNewGame),newGame()});