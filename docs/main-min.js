let cardNumArr=[];const col=8;let dataCollection,timerInt,gameState="",hintArr=[],historyArr=[],historyMax=5;function buildCardNumArr(){let e=[];for(let t=1;t<=52;t++)e.push(t);cardNumArr=shuffleArr(e)}function shuffleArr(e){for(let t,a,r=e.length;r;t=parseInt(Math.random()*r),a=e[--r],e[r]=e[t],e[t]=a);return e}function getDataCollection(){let e=[[],[],[],[],[],[],[],[]];for(let t=0;t<cardNumArr.length;t++){let a=getSuit(cardNumArr[t])+(cardNumArr[t]%13+1).toString();e[t%col].push(a)}return e}function getSuit(e){return e<14?"S":e>13&&e<27?"H":e>26&&e<40?"D":"C"}function dealCard(){gameState="playing";for(let e=0;e<dataCollection.length;e++){let t=$(".working-area>li").eq(e);for(let a=0;a<dataCollection[e].length;a++){let r,n=dataCollection[e][a].toString(),l=n.slice(0,1),i=n.substring(1),o="<div id='"+n+"' class='card'  data-suit='"+l+"' data-num='"+i+"' data-color='"+(r="S"==l||"C"==l?"B":"R")+"' data-pos=c"+e+"r"+a+" style='background-image:"+('url("img/cards_background/'+n+'.png")')+"' draggable='"+(a==dataCollection[e].length-1)+"' ondragstart='drag(event)' ></div>";if(0==a)t.append(o);else{let t=dataCollection[e][a-1];$("#"+t).append(o)}}}}function dealTransition(){$(".card").on("click",cardClicked),$(".card").addClass("show"),updateDraggable(),startTimer()}function allowDrop(e){e.preventDefault(),e.target.classList.add("drop-target-focus")}function dragEnter(e){}function dragLeave(e){e.target.classList.remove("drop-target-focus")}function drag(e){e.dataTransfer.setData("text",e.target.id)}function dropHome(e){e.preventDefault();let t=e.dataTransfer.getData("text"),a=document.getElementById(t),r=e.target;r.classList.remove("drop-target-focus");let n=parseInt(a.getAttribute("data-num")),l=a.getAttribute("data-suit");if(!(a.childElementCount>0)){if(-1!=r.className.indexOf("home-cell")){if(-1==r.id.indexOf(l))return;if(n!=parseInt(r.getAttribute("data-top"))+1)return}else{if(r.getAttribute("data-suit")!=l)return;if(parseInt(r.getAttribute("data-num"))!=n-1)return}pushHistory({id:a.getAttribute("id"),now:a.getAttribute("data-pos"),new:"h"+l+(n-1)}),$("#"+l+"-home").attr("data-top",n),a.setAttribute("data-pos",["h"+l+(n-1)]),a.setAttribute("draggable",!1),r.appendChild(a),clearHint(),updateDraggable()}}function dropTemp(e){e.preventDefault(),e.target.classList.remove("drop-target-focus");let t=e.dataTransfer.getData("text"),a=document.getElementById(t);if(a.childElementCount>0)return;if(-1==e.target.className.indexOf("temp-cell"))return;let r=$(e.target).index();pushHistory({id:a.getAttribute("id"),now:a.getAttribute("data-pos"),new:"t"+r}),a.setAttribute("data-pos",["t"+r]),e.target.appendChild(a),clearHint(),updateDraggable()}function drop(e){e.preventDefault();let t=e.dataTransfer.getData("text"),a=document.getElementById(t),r=e.target;r.classList.remove("drop-target-focus");let n,l,i=parseInt(a.getAttribute("data-num"));if(-1!=r.className.indexOf("cell")){if(r.childElementCount>0)return;n=$(r).index(),l={id:a.getAttribute("id"),now:a.getAttribute("data-pos"),new:"c"+n+"r0"}}else{if(r.getAttribute("data-color")==a.getAttribute("data-color"))return;if(parseInt(r.getAttribute("data-num"))!=i+1)return;n=r.getAttribute("data-pos").substr(1,1);let e=parseInt(r.getAttribute("data-pos").substr(3))+1;l={id:a.getAttribute("id"),now:a.getAttribute("data-pos"),new:"c"+n+"r"+e}}pushHistory(l),r.appendChild(a),clearHint(),updateDraggable(),updateOrder(n)}function checkAutoHome(e,t){let a=e.getAttribute("data-suit"),r=e.getAttribute("data-num"),n=$(e);if(!(r>t))for(let l=0;l<$(".home-cell").length;l++){let i=$(".home-cell")[l];-1!=i.id.indexOf(a)&&i.getAttribute("data-top")==r-1&&(i.setAttribute("data-top",r),n.addClass("autohome"),t>2?setTimeout(goHome,300,i,e,r-1):setTimeout(goHome,1e3,i,e,r-1))}}function goHome(e,t,a){let r=t.getAttribute("data-suit");if(e.childElementCount>0){e.getElementsByTagName("div")[parseInt(a-1)].append(t)}else e.append(t);pushHistory({id:t.getAttribute("id"),now:t.getAttribute("data-pos"),new:"h"+r+a}),t.setAttribute("data-pos",["h"+r+a]),t.setAttribute("draggable",!1),t.classList.remove("autohome"),clearHint(),updateDraggable()}function updateOrder(e){let t=document.querySelectorAll(".working-area>li")[e],a=t.querySelectorAll("div").length,r=t;for(let t=0;t<a;t++)newPos="c"+e+"r"+t,r.children[0].setAttribute("data-pos",newPos),r=r.children[0]}function getTotalRow(e){return document.querySelectorAll(".working-area>li")[e].querySelectorAll("div").length}function updateDraggable(){for(let e=0;e<col;e++){let t=document.querySelectorAll(".working-area>li")[e].querySelectorAll("div"),a=t.length;if(0!=a){t[a-1].setAttribute("draggable",!0);for(let e=a-1;e>=0;e--){let r=t[e];if(0!=e){let a=t[e-1];if(parseInt(r.getAttribute("data-num"))!=parseInt(a.getAttribute("data-num"))-1)break;if(r.getAttribute("data-color")==a.getAttribute("data-color"))break;a.setAttribute("draggable",!0)}else 1==a&&r.setAttribute("draggable",!0)}}}checkHint(),checkWin()}function checkHint(){let e=!1;for(let t=0;t<col;t++){let a=document.getElementsByClassName("working-area")[0].getElementsByTagName("li")[t];if(a.getElementsByTagName("div").length>0){let r=a.querySelector("div[draggable=true]");for(let a=0;a<col;a++){if(t==a)continue;let n=document.getElementsByClassName("working-area")[0].getElementsByTagName("li")[a].getElementsByTagName("div");if(n.length>0){if(e=checkEachCol(r,n[n.length-1]))break}}if(e)break}}if(!e){let t=document.querySelectorAll(".temp-cell>div");if(t.length>0)for(let a=0;a<t.length;a++){for(let r=0;r<col;r++){let n=document.getElementsByClassName("working-area")[0].getElementsByTagName("li")[r].getElementsByTagName("div");if(n.length>0){let r=n[n.length-1];if(e=checkEachCol(t[a],r))break}}if(e)break}}e?$(".hint-btn").removeClass("disable"):$(".hint-btn").addClass("disable")}function checkEachCol(e,t){return parseInt(e.getAttribute("data-num"))==parseInt(t.getAttribute("data-num"))-1&&(e.getAttribute("data-color")!=t.getAttribute("data-color")&&(hintArr.push(e.getAttribute("id")),hintArr.push(t.getAttribute("id")),!0))}function showHint(){for(let e=0;e<hintArr.length;e++){let t=document.getElementById(hintArr[e]);t.classList.add("hint");let a=t.getElementsByTagName("div");a.length>0&&a[a.length-1].classList.add("hint-end")}}function clearHint(){for(let e=0;e<hintArr.length;e++){let t=document.getElementById(hintArr[e]);t.classList.remove("hint");let a=t.getElementsByTagName("div");a.length>0&&a[a.length-1].classList.remove("hint-end")}hintArr=[]}function pushHistory(e){historyArr.length<historyMax?historyArr.push(e):(historyArr.shift(),historyArr.push(e)),historyArr.length>0?($(".restart-btn").hasClass("disable")&&$(".restart-btn").removeClass("disable"),$(".undo-btn").hasClass("disable")&&$(".undo-btn").removeClass("disable")):($(".restart-btn").hasClass("disable")||$(".restart-btn").addClass("disable"),$(".undo-btn").hasClass("disable")||$(".undo-btn").addClass("disable"))}function popHistory(){historyArr.pop(),historyArr.length<1&&($(".undo-btn").hasClass("disable")||$(".undo-btn").addClass("disable"))}function undo(){if(historyArr.length<1)return;let e=historyArr[historyArr.length-1],t=e.new,a=document.getElementById(e.id),r=e.now;switch(t.substring(0,1)){case"h":-1!=r.indexOf("t")?(removeCardFromHome(a,t),appendBacktoTemp(a,r)):(removeCardFromHome(a,t),appendBacktoCard(a,r));break;case"t":-1!=r.indexOf("t")?(removeCardFromTemp(a,t),appendBacktoTemp(a,r)):(removeCardFromTemp(a,t),appendBacktoCard(a,r));break;case"c":-1!=r.indexOf("t")?(removeCardFromCard(a,t),appendBacktoTemp(a,r)):(removeCardFromCard(a,t),appendBacktoCard(a,r))}popHistory(),clearHint(),updateDraggable()}function removeCardFromHome(e,t){let a=t.substring(1,2).toUpperCase(),r=document.getElementById(a+"-home"),n=t.substr(2);if(0!=n){r.getElementsByTagName("div")[parseInt(n-1)].removeChild(e)}else r.removeChild(e);r.setAttribute("data-top",n)}function removeCardFromTemp(e,t){let a=t.substring(1,2),r=document.getElementsByClassName("temp-cell")[a];console.log("temp to Card "+a+".  temp cell"+r),r.removeChild(e)}function removeCardFromCard(e,t){let a,r=t.substring(1,2),n=document.getElementsByClassName("working-area")[0].getElementsByTagName("li")[r],l=t.substr(3);(a=0==l?n:n.getElementsByTagName("div")[l-1]).removeChild(e),updateOrder(r)}function appendBacktoCard(e,t){let a,r=t.substring(1,2),n=document.getElementsByClassName("working-area")[0].getElementsByTagName("li")[r],l=t.substr(3);(a=0==l?n:n.getElementsByTagName("div")[l-1]).append(e),updateOrder(r)}function appendBackToTemp(e,t){let a=t.substring(1,2),r=document.getElementsByClassName("temp-cell")[a];e.setAttribute("data-pos",["t"+a]),r.append(e)}function checkWin(){0==document.querySelectorAll('.working-area div[draggable="false"]').length&&autoEnd()}function autoEnd(){if(document.querySelectorAll(".working-area div").length>0||document.querySelectorAll(".temp-cell div").length>0){for(let e=0;e<col;e++){let t=document.querySelectorAll(".working-area>li")[e].querySelectorAll("div"),a=t.length;if(0!=a){checkAutoHome(t[a-1],13)}}for(let e=0;e<document.querySelectorAll(".temp-cell").length;e++){let t=document.querySelectorAll(".temp-cell")[e];if(t.children.length>0){checkAutoHome(t.children[0],13)}}}else gameState="win",showWinScreen()}function startTimer(){let e,t,a,r=0;timerInt=window.setInterval(()=>{"playing"==gameState&&(r++,a=parseInt(r/3600,10),e=parseInt(r/60,10),t=parseInt(r%60,10),a=a<10?`0${a}`:a,e=e<10?`0${e}`:e,t=t<10?`0${t}`:t,$(".time>span").text(`${a}:${e}:${t}`))},1e3)}function cleanTimer(){null!=timerInt&&(window.clearInterval(timerInt),timerInt=void 0,$(".time>span").text("00:00"))}function cleanup(){$(".temp-cell").empty(),$(".home-cell").empty(),$(".home-cell").attr("data-top",0),$(".working-area>li").empty(),hintArr=[],historyArr=[],cleanTimer(),gameState=""}function newGame(){document.querySelector(".mask").classList.contains("show")&&closeMask(),"playing"!=gameState?(buildCardNumArr(),dataCollection=getDataCollection(),cleanup(),dealCard(),setTimeout(dealTransition,1e3)):showConfirmWindow()}function restartGame(e){e.target.classList.contains("disable")||(document.querySelector(".mask").classList.contains("show")&&closeMask(),cleanup(),dealCard(),setTimeout(dealTransition,1e3))}function confirmNewGame(){gameState="",newGame()}function cardClicked(e){e.stopPropagation();let t=e.target,a=t.getAttribute("data-pos");if("t"!=a.substr(0,1)){let e=a.substr(1,1),r=a.substr(3);document.getElementsByClassName("working-area")[0].getElementsByTagName("li")[e].getElementsByTagName("div").length==parseInt(r)+1&&checkAutoHome(t,13)}else checkAutoHome(t,13)}function hintClicked(e){e.target.classList.contains("disable")||showHint()}function undoClicked(e){e.target.classList.contains("disable")||undo()}function showConfirmWindow(){$(".mask").removeClass("hide").addClass("show"),$(".info-window .confirm-pan").addClass("show"),$(".info-window").removeClass("hide").addClass("show")}function showWinScreen(){$(".mask").removeClass("hide").addClass("show"),$(".info-window .win-pan").addClass("show"),$(".info-window").removeClass("hide").addClass("show")}function closeMask(){$(".info-window").removeClass("show"),$(".mask").removeClass("show"),setTimeout(hideMask,1e3)}function hideMask(){$(".info-window").addClass("hide"),$(".info-window .pan").removeClass("show"),$(".mask").addClass("hide")}$("document").ready(function(){$(".new-game-btn").on("click",newGame),$(".restart-btn").on("click",restartGame),$(".hint-btn").on("click",hintClicked),$(".undo-btn").on("click",undoClicked),$(".close-btn").on("click",closeMask),$(".new-game-confirm-btn").on("click",confirmNewGame),newGame()});